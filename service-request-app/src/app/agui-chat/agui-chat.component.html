<div class="d-flex flex-column" style="min-height: 300px">
  <div class="flex-grow-1 overflow-auto p-2 mb-2">
    <div *ngIf="(agui.loading$ | async)" class="progress mb-2" style="height:6px;">
      <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
    </div>
    
    <!-- Chat messages -->
    <div class="p-0">
      <div *ngFor="let m of agui.messages$ | async" class="mb-2 d-flex" [ngClass]="{'justify-content-end': m.role==='user'}">
        <div class="d-flex align-items-start" [ngClass]="{'flex-row-reverse': m.role==='user'}">
          <div class="rounded-circle d-inline-flex align-items-center justify-content-center me-2 ms-2"
               [ngClass]="m.role==='assistant' ? 'bg-secondary text-white' : 'bg-primary text-white'"
               style="width:28px;height:28px;font-size:12px;">{{ m.role==='assistant' ? 'A' : 'U' }}</div>
          <div class="shadow-sm" [ngClass]="m.role==='assistant' ? 'bg-white' : 'bg-primary text-white'"
               style="border-radius:14px;padding:10px 12px; max-width: 85%;">
            {{ m.text }}
          </div>
        </div>
      </div>
    </div>

    <!-- Welcome and smart suggestions -->
    <div *ngIf="showWelcome" class="mt-3">
      <div class="card border-0 shadow-sm" style="border-radius: 16px;">
        <div class="card-body" style="background: var(--app-card-bg); color: var(--app-text); font-family: var(--app-font);">
          <ng-container *ngIf="(matchedRequests?.length || 0) > 0; else customHelp">
            <p class="mb-3">These seem relevant based on your message. Choose one below, or describe your form fields.</p>
            <div class="d-flex flex-wrap gap-2">
              <button class="btn btn-sm btn-outline-primary" *ngFor="let r of matchedRequests" (click)="choose(r.key)">
                <span class="me-1">‚úÖ</span>{{ r.label }}
              </button>
            </div>
          </ng-container>
          <ng-template #customHelp>
            <p class="mb-3">Paste your form fields or describe them (e.g., name:text (required), email:email, status:select (Pending, Approved)).</p>
            <button class="btn btn-sm btn-primary" (click)="startFieldSpecPrompt()"><span class="me-1">üìù</span>Describe a new form</button>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Inline schema editor card on agent side when schema exists and not confirmed -->
    <div *ngIf="state?.schema && !state?.schema_confirmed" class="mt-3">
      <div class="card border-0 shadow-sm" style="border-radius: 16px;">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center" (click)="toggleEditor()" style="cursor: pointer;">
            <div>
              <strong>Adjust form fields</strong>
              <small class="text-muted ms-2">{{ state?.schema?.fields?.length || 0 }} fields</small>
            </div>
            <div class="text-muted">{{ editorExpanded ? '‚ñæ' : '‚ñ∏' }}</div>
          </div>
          <div *ngIf="editorExpanded" class="mt-2">
            <app-schema-editor [schema]="state?.schema" (apply)="onAgentSideApply($event)"></app-schema-editor>
          </div>
        </div>
      </div>
    </div>

  </div>
  <div class="input-group">
    <input [(ngModel)]="input" (keyup.enter)="send()" class="form-control" />
  </div>
</div>

