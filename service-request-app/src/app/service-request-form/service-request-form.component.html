<form [formGroup]="form" (ngSubmit)="submit()" class="row g-3">
  <div class="col-12 d-flex justify-content-end" *ngIf="schema?.fields?.length">
    <button type="button" class="btn btn-sm btn-outline-secondary" (click)="openEditor()">Edit fields</button>
  </div>
  <ng-container *ngIf="schema?.fields as fields">
    <ng-container *ngFor="let f of fields; let i = index">
      <div class="col-12" [ngClass]="{'col-md-6': f.type!=='textarea' && f.type!=='select', 'col-md-4': f.type==='select'}">
        <label class="form-label">{{ f.label || f.key }}</label>
        <ng-container [ngSwitch]="f.type">
          <input *ngSwitchCase="'text'" class="form-control" [formControlName]="f.key" />
          <input *ngSwitchCase="'email'" type="email" class="form-control" [formControlName]="f.key" />
          <input *ngSwitchCase="'number'" type="number" class="form-control" [formControlName]="f.key" />
          <input *ngSwitchCase="'date'" type="date" class="form-control" [formControlName]="f.key" />
          <input *ngSwitchCase="'password'" type="password" class="form-control" [formControlName]="f.key" />
          <input *ngSwitchCase="'tel'" type="tel" class="form-control" [formControlName]="f.key" />
          <input *ngSwitchCase="'url'" type="url" class="form-control" [formControlName]="f.key" />
          <input *ngSwitchCase="'color'" type="color" class="form-control form-control-color" [formControlName]="f.key" />
          <input *ngSwitchCase="'time'" type="time" class="form-control" [formControlName]="f.key" />
          <input *ngSwitchCase="'datetime'" type="datetime-local" class="form-control" [formControlName]="f.key" />
          <input *ngSwitchCase="'datetime-local'" type="datetime-local" class="form-control" [formControlName]="f.key" />
          <input *ngSwitchCase="'month'" type="month" class="form-control" [formControlName]="f.key" />
          <input *ngSwitchCase="'week'" type="week" class="form-control" [formControlName]="f.key" />
          <input *ngSwitchCase="'range'" type="range" class="form-range" [formControlName]="f.key" />
          <textarea *ngSwitchCase="'textarea'" rows="3" class="form-control" [formControlName]="f.key"></textarea>
          <select *ngSwitchCase="'select'" class="form-select" [formControlName]="f.key">
            <option *ngFor="let opt of (f.options||[])" [value]="opt">{{ opt }}</option>
          </select>
          <div *ngSwitchCase="'radio'" class="d-flex gap-3">
            <div *ngFor="let opt of (f.options||[])" class="form-check">
              <input class="form-check-input" type="radio" [value]="opt" [formControlName]="f.key" [id]="f.key + '_' + opt">
              <label class="form-check-label" [attr.for]="f.key + '_' + opt">{{ opt }}</label>
            </div>
          </div>
          <div *ngSwitchCase="'checkbox'" class="d-flex flex-column gap-2">
            <div *ngFor="let opt of (f.options||[])" class="form-check">
              <input class="form-check-input" type="checkbox" [checked]="isChecked(f.key, opt)"
                     (change)="toggleCheckbox(f.key, opt, $event)" [id]="f.key + '_' + opt">
              <label class="form-check-label" [attr.for]="f.key + '_' + opt">{{ opt }}</label>
            </div>
          </div>
          <input *ngSwitchDefault class="form-control" [formControlName]="f.key" />
        </ng-container>
      </div>
    </ng-container>
  </ng-container>
  <div class="col-12 d-flex justify-content-between align-items-center mt-2">
    <div class="text-muted" *ngIf="done">All fields collected from chat.</div>
    <button *ngIf="allowSubmit" type="submit" class="btn btn-success" [disabled]="!form.valid">{{ schema?.submitLabel || 'Submit' }}</button>
  </div>
</form>

<div class="mt-3">
  <div class="input-group">
    <input #reply class="form-control" placeholder="Answer the agent..." (keyup.enter)="onUserReply(reply.value); reply.value=''" />
  </div>
</div>

<!-- Lightweight modal for schema editing -->
<div *ngIf="showEditor" class="position-fixed top-0 start-0 w-100 h-100" style="background: rgba(0,0,0,0.35); z-index:1050;">
  <div class="position-absolute top-50 start-50 translate-middle" style="width: min(820px, 96vw);">
    <div class="card shadow" style="border-radius: 12px;">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Edit form fields</span>
        <button type="button" class="btn btn-sm btn-light" (click)="closeEditor()">âœ•</button>
      </div>
      <div class="card-body">
        <app-schema-editor [schema]="schema" (cancel)="closeEditor()" (apply)="onApplyEdits($event)"></app-schema-editor>
      </div>
    </div>
  </div>
</div>

